---
import type { GetStaticPaths } from "astro";
import Layout from "@/layouts/Layout.astro";
const { turso } = Astro.locals;
import { BlogContent } from "@/components/react/blog/BlogContent";
import type { ContentBlocks } from "@/components/react/blog/types";
import { ShareButtons } from "@/components/react/blog/ShareButtons";
import { ViewTracker } from "@/components/ViewTracker";
import { transformTiptapToContentBlocks } from "@/lib/contentTransformer";
import { formatDate, toIsoString } from "@/lib/date";
import { ChevronLeft, ChevronRight, Home } from "lucide-react";
import {
    defaultLang,
    localeByLang,
    translations,
    type Language,
} from "@/lib/i18n";

const lang = (Astro.locals.lang as Language | undefined) ?? defaultLang;
const t = translations[lang];
const locale = localeByLang[lang];

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

let post: any = null;
let morePosts: any[] = [];

if (!turso) {
    console.error(
        `[SlugPage] Turso client missing in Astro.locals for slug: ${slug}`,
    );
} else {
    try {
        console.log(`[SlugPage] Fetching post: ${slug}`);
        const { rows } = await turso.execute({
            sql: "SELECT * FROM posts WHERE slug = ? LIMIT 1",
            args: [slug as string],
        });
        post = rows[0];

        if (post) {
            console.log(`[SlugPage] Post found. Fetching related posts...`);
            const { rows: morePostsRows } = await turso.execute({
                sql: "SELECT * FROM posts WHERE STATUS = 'PUBLISHED' AND slug != ? ORDER BY createdAt DESC LIMIT 3",
                args: [slug as string],
            });

            morePosts = morePostsRows.map((p: any) => ({
                title: p.title as string,
                slug: p.slug as string,
                date:
                    formatDate(p.createdAt, locale, {
                        month: "short",
                        day: "2-digit",
                        year: "numeric",
                    }) ?? "N/A",
            }));
        } else {
            console.warn(`[SlugPage] Post not found for slug: ${slug}`);
        }
    } catch (error) {
        console.error(
            `[SlugPage] Error fetching post data from Turso for slug ${slug}:`,
            error,
        );
    }
}

if (!post) {
    return Astro.redirect("/404");
}

const postDescription =
    (post.excerpt as string | undefined) ??
    t.seo.pages.blogPostDescriptionFallback;
const postImage = (post.featuredImage as string | undefined) ?? undefined;
const shareUrl = new URL(
    `/blog/${slug}`,
    Astro.site ?? Astro.url,
).toString();
const publishedTime = toIsoString(post.createdAt);
const modifiedTime = toIsoString(post.updatedAt);
const section = (post.categorie as string | undefined) ?? undefined;
let tags: string[] | undefined;
if (Array.isArray(post.tags)) {
    tags = post.tags.map((tag: unknown) => String(tag));
} else if (typeof post.tags === "string") {
    const parsed = post.tags
        .split(",")
        .map((tag) => tag.trim())
        .filter(Boolean);
    if (parsed.length) {
        tags = parsed;
    }
}

const isFeatured = Boolean(post.featured);

let content: ContentBlocks = { blocks: [] };
try {
    let parsedContent: unknown = post.content;
    if (typeof post.content === "string") {
        try {
            parsedContent = JSON.parse(post.content);
        } catch {
            parsedContent = post.content;
        }
    }
    content = transformTiptapToContentBlocks(parsedContent);
} catch (error) {
    console.error("Error parsing blog content:", error);
}
---

<Layout
    title={post.title as string}
    description={postDescription}
    image={postImage}
    imageAlt={post.title as string}
    type="article"
    publishedTime={publishedTime}
    modifiedTime={modifiedTime}
    section={section}
    tags={tags}
>
    <ViewTracker slug={slug} client:load />
    <article class="container max-w-5xl mx-auto px-4 pt-44 relative z-32 pb-32">
        {/* Navigation Header */}
        <nav
            class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-12 animate-fade-in group"
        >
            <a
                href="/blog"
                class="inline-flex items-center gap-2 text-primary-green hover:gap-3 transition-all duration-300 font-medium group/back"
            >
                <ChevronLeft
                    className="w-5 h-5 transition-transform group-hover/back:-translate-x-1"
                />
                {t.blog.backToBlog}
            </a>

            <div
                class="flex items-center gap-2 text-sm text-neutral-500 font-mono overflow-x-auto whitespace-nowrap pb-2 md:pb-0"
            >
                <a
                    href="/"
                    class="hover:text-primary-green transition-colors flex items-center gap-1"
                >
                    <Home className="w-3.5 h-3.5" /> {t.blog.home}
                </a>
                <ChevronRight className="w-4 h-4 opacity-30" />
                <a
                    href="/blog"
                    class="hover:text-primary-green transition-colors">{t.blog.blog}</a
                >
                <ChevronRight className="w-4 h-4 opacity-30" />
                <span
                    class="text-primary-green/60 uppercase tracking-tighter truncate max-w-[150px] md:max-w-none"
                >
                    {(post.categorie as string) || t.blog.categoryFallback}
                </span>
                <ChevronRight className="w-4 h-4 opacity-30" />
                <span
                    class="text-neutral-400 truncate max-w-[100px] md:max-w-[200px]"
                >
                    {post.title}
                </span>
            </div>
        </nav>

        <header class="mb-12">
            {isFeatured && (
                <div class="mb-4 inline-flex items-center gap-1 rounded-full border border-accent/50 bg-accent/10 px-3 py-1 text-xs font-medium text-accent backdrop-blur-sm">
                    <span class="h-1.5 w-1.5 rounded-full bg-accent"></span>
                    {t.blog.featuredBadge}
                </div>
            )}
            <h1 class="text-4xl md:text-6xl font-bold leading-tight mb-6">
                {post.title}
            </h1>
            <div
                class="flex items-center gap-6 text-neutral-500 font-mono text-sm border-y border-white/5 py-6"
            >
                <span class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-primary-green"></span>
                    {formatDate(post.createdAt, locale, {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                    }) ?? "N/A"}
                </span>
                <span class="hidden md:inline text-white/10">|</span>
                <span>{(post.read_time as string) || "5"} {t.blog.minRead}</span>
            </div>

            <div class="mt-8">
                <ShareButtons
                    title={post.title as string}
                    url={shareUrl}
                    labels={t.share}
                    client:load
                />
            </div>
        </header>

        <div class="max-w-4xl mx-auto mb-16">
            <img
                class="w-full rounded-2xl shadow-[0_0_50px_rgba(0,212,124,0.15)] border border-white/10"
                src={post.featuredImage as string}
                alt={post.title as string}
                loading="eager"
                decoding="async"
                fetchpriority="high"
            />
        </div>

        <div
            class="max-w-4xl mx-auto prose dark:prose-invert prose-lg prose-primary"
        >
            <BlogContent
                content={content}
                noContentLabel={t.blog.noContent}
                client:load
            />
        </div>

        {/* More articles loader */}
        <footer class="mt-32 pt-20 border-t border-white/5">
            <div class="flex justify-between items-end mb-12">
                <div>
                    <h2 class="text-3xl font-bold mb-4">{t.blog.youLikedIt}</h2>
                    <p class="text-neutral-500">
                        {t.blog.keepExploring}
                    </p>
                </div>
                <a
                    href="/blog"
                    class="text-primary-green hover:underline decoration-primary-green/30 underline-offset-8 transition-all"
                >
                    {t.blog.seeAllArticles}
                </a>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                {
                    morePosts.map((p) => (
                        <a
                            href={`/blog/${p.slug}`}
                            class="group p-6 rounded-2xl bg-white/5 border border-white/5 hover:border-primary-green/30 hover:bg-primary-green/5 transition-all duration-500"
                        >
                            <time class="text-xs font-mono text-neutral-500 mb-3 block">
                                {p.date}
                            </time>
                            <h3 class="text-xl font-medium text-neutral-200 group-hover:text-primary-green transition-colors leading-snug">
                                {p.title}
                            </h3>
                            <div class="mt-6 flex items-center gap-2 text-sm text-primary-green opacity-0 group-hover:opacity-100 transition-all translate-x-[-10px] group-hover:translate-x-0">
                                {t.blog.readMore} <ChevronRight className="w-4 h-4" />
                            </div>
                        </a>
                    ))
                }
            </div>
        </footer>
    </article>
</Layout>
