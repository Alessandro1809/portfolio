---
import "../styles/global.css";
import ClientRouter from "astro/components/ClientRouter.astro";
import Header from "../components/layoutComponents/Header.astro";
import Footer from "../components/layoutComponents/Footer.astro";
import { getImage } from "astro:assets";
import { defaultLang, localeByLang, translations, type Language } from "@/lib/i18n";
import defaultOgImage from "@/assets/presentacion_portfolio-Cover.jpg";

const lang = (Astro.locals.lang as Language | undefined) ?? defaultLang;
const t = translations[lang];

const {
	title,
	description,
	image,
	imageAlt,
	canonical,
	type = "website",
	noindex = false,
	publishedTime,
	modifiedTime,
	section,
	tags,
} = Astro.props as {
	title?: string;
	description?: string;
	image?: string;
	imageAlt?: string;
	canonical?: string;
	type?: "website" | "article";
	noindex?: boolean;
	publishedTime?: string;
	modifiedTime?: string;
	section?: string;
	tags?: string[];
};

const baseUrl = Astro.site ?? new URL(Astro.url.origin);
const canonicalUrl = canonical
	? new URL(canonical, baseUrl).toString()
	: new URL(Astro.url.pathname, baseUrl).toString();

const siteName = t.seo.siteName;
const resolvedTitle = title
	? title.includes(siteName)
		? title
		: `${title} | ${siteName}`
	: t.seo.defaultTitle;
const resolvedDescription = description ?? t.seo.defaultDescription;
const pageHeading = title ?? resolvedTitle;

const ogImage = await getImage({
	src: defaultOgImage,
	width: 1200,
	height: 630,
	format: "webp",
});

const resolveUrl = (value: string) => {
	try {
		return new URL(value).toString();
	} catch {
		return new URL(value, baseUrl).toString();
	}
};

const resolvedImage = image ? resolveUrl(image) : new URL(ogImage.src, baseUrl).toString();
const resolvedImageAlt = imageAlt ?? t.seo.defaultOgAlt;
const locale = localeByLang[lang];
const alternateLocale = lang === "en" ? localeByLang.es : localeByLang.en;

const baseUrlString = baseUrl.toString().replace(/\/$/, "");
const personId = `${baseUrlString}#person`;
const websiteId = `${baseUrlString}#website`;
const pageSchema =
	type === "article"
		? {
				"@context": "https://schema.org",
				"@type": "BlogPosting",
				"@id": canonicalUrl,
				mainEntityOfPage: canonicalUrl,
				headline: pageHeading,
				name: pageHeading,
				description: resolvedDescription,
				image: resolvedImage,
				datePublished: publishedTime,
				dateModified: modifiedTime,
				author: { "@id": personId },
				publisher: { "@id": personId },
				articleSection: section,
				keywords: Array.isArray(tags) ? tags.join(", ") : undefined,
				inLanguage: locale,
				isPartOf: { "@id": websiteId },
			}
		: {
				"@context": "https://schema.org",
				"@type": "WebPage",
				"@id": canonicalUrl,
				url: canonicalUrl,
				name: pageHeading,
				description: resolvedDescription,
				inLanguage: locale,
				isPartOf: { "@id": websiteId },
				publisher: { "@id": personId },
			};

const structuredData = [
	{
		"@context": "https://schema.org",
		"@type": "Person",
		"@id": personId,
		name: siteName,
		url: baseUrl.toString(),
		image: resolvedImage,
		jobTitle: t.profile.title,
		sameAs: [
			"https://github.com/Alessandro1809",
			"https://www.linkedin.com/in/alessandrodg/",
			"https://x.com/ddiaz_ale",
		],
	},
	{
		"@context": "https://schema.org",
		"@type": "WebSite",
		"@id": websiteId,
		name: siteName,
		url: baseUrl.toString(),
		description: t.seo.defaultDescription,
		publisher: { "@id": personId },
	},
	pageSchema,
];
---

<!doctype html>
<html lang={lang}>
	<head>
		<ClientRouter />
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<meta name="description" content={resolvedDescription} />
		<meta name="author" content={siteName} />
		<meta name="theme-color" content="#0B100E" />
		{noindex && <meta name="robots" content="noindex, follow" />}
		<link rel="canonical" href={canonicalUrl} />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<script src="../lib/aos.js"></script>
		<meta name="generator" content={Astro.generator} />
		<title>{resolvedTitle}</title>
		<meta property="og:site_name" content={siteName} />
		<meta property="og:title" content={resolvedTitle} />
		<meta property="og:description" content={resolvedDescription} />
		<meta property="og:type" content={type} />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:image" content={resolvedImage} />
		<meta property="og:image:alt" content={resolvedImageAlt} />
		<meta property="og:locale" content={locale} />
		<meta property="og:locale:alternate" content={alternateLocale} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={resolvedTitle} />
		<meta name="twitter:description" content={resolvedDescription} />
		<meta name="twitter:image" content={resolvedImage} />
		<meta name="twitter:image:alt" content={resolvedImageAlt} />
		{type === "article" && publishedTime && (
			<meta property="article:published_time" content={publishedTime} />
		)}
		{type === "article" && modifiedTime && (
			<meta property="article:modified_time" content={modifiedTime} />
		)}
		{type === "article" && section && (
			<meta property="article:section" content={section} />
		)}
		{type === "article" &&
			Array.isArray(tags) &&
			tags.map((tag) => <meta property="article:tag" content={tag} />)}
		<script type="application/ld+json">
			{JSON.stringify(structuredData)}
		</script>
	</head>
	<body>
		<div class="min-h-screen w-full relative bg-black overflow-hidden">
			{/* Prismatic Aurora Burst - Multi-layered Gradient */}
			<div
				class="absolute inset-0 z-0"
				style={{
					background: `
          radial-gradient(ellipse 120% 20% at 70% 20%, rgba(0, 209, 53, 0.12), transparent 50%),
          radial-gradient(ellipse 100% 20% at 30% 10%, rgba(173, 130, 255, 0.15), transparent 60%),
          radial-gradient(ellipse 90% 20% at 50% 0%, rgba(38, 255, 108, 0.10), transparent 65%),
          radial-gradient(ellipse 110% 20% at 80% 30%, rgba(51, 102, 51, 0.08), transparent 40%),
          #0B100E
        `,
				}}
			>
			</div>
			<Header />
			<slot />
			<Footer />
		</div>
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
	}
</style>

<script is:inline>
	const setupLangToggle = () => {
		const button = document.getElementById("lang-toggle");
		if (!button || button.dataset.listenerAttached) return;

		button.addEventListener("click", () => {
			const nextLang = button.dataset.nextLang;
			if (!nextLang) return;

			document.cookie = `lang=${nextLang}; Path=/; Max-Age=31536000; SameSite=Lax`;
			window.location.reload();
		});

		button.dataset.listenerAttached = "true";
	};

	setupLangToggle();
	document.addEventListener("astro:after-swap", setupLangToggle);
</script>
