---
import Coffee from "@/components/ui/icons/Coffee.astro";
import GoToAll from "@/components/ui/icons/goToAll.astro";
const { turso } = Astro.locals;
import { ArrowUpRight } from "lucide-react";
import {
    defaultLang,
    localeByLang,
    translations,
    type Language,
} from "@/lib/i18n";
import { formatDate } from "@/lib/date";

const lang = (Astro.locals.lang as Language | undefined) ?? defaultLang;
const t = translations[lang];
const locale = localeByLang[lang];

let recentPosts: any[] = [];
if (!turso) {
    console.error("[BlogSection] Turso client is missing in Astro.locals");
} else {
    try {
        console.log("[BlogSection] Fetching recent posts...");
        const result = await turso.execute({
            sql: "SELECT * FROM posts WHERE STATUS = 'PUBLISHED' ORDER BY createdAt DESC LIMIT 4",
            args: [],
        });

        console.log(`[BlogSection] Found ${result.rows.length} rows.`);

        recentPosts = result.rows.map((post: any) => ({
            title: post.title as string,
            slug: post.slug as string,
            date:
                formatDate(post.createdAt, locale, {
                    month: "short",
                    day: "2-digit",
                    year: "numeric",
                }) ?? "N/A",
        }));
    } catch (error) {
        console.error(
            "[BlogSection] Error fetching recent posts from Turso:",
            error,
        );
    }
}
---

<section
    class="container mx-auto max-w-12xl relative z-10 pb-[30vh] px-4 sm:px-6 md:px-8"
    data-aos="fade-up"
    data-aos-duration="800"
    data-aos-once="true"
>
    <header class="mb-16">
        <div class="flex justify-between md:gap-8 gap-4 items-end">
            <div class="flex items-center gap-2">
                <div class="p-2 h-16 w-16 border border-primary-green rounded-full md:block hidden">
                    <Coffee />
                </div>
                <h2 class="md:text-4xl sm:text-3xl text-xl font-bold max-w-2xl">
                    {t.blogSection.heading}
                </h2>
            </div>
            
            <a
                href="/blog"
                class="flex flex-nowrap items-center gap-2 md:text-xl text-lg text-primary-green hover:underline decoration-primary-green/30 underline-offset-8 transition-all whitespace-nowrap"
            >
                {t.blogSection.viewAll} <GoToAll />
            </a>
        </div>
        <div
            class="h-px bg-linear-to-r from-primary-green/50 via-primary-green to-primary-green/50 mt-4 opacity-30"
        >
        </div>
        <div
            class="bg-linear-to-br from-primary-green/20 to-purple-500/20 w-96 h-96 rounded-full absolute right-0 top-0 -z-1 blur-[100px]"
        >
        </div>
        <p class="text-neutral-400 mt-8 text-sm max-w-3xl leading-relaxed">
            {t.blogSection.description}
        </p>
    </header>

    <div
        class="grid gap-px bg-white/5 border border-white/5 rounded-2xl overflow-hidden"
    >
        {
            recentPosts.map((post) => (
                <a
                    href={`/blog/${post.slug}`}
                    class="group flex items-center justify-between p-6 md:p-8 bg-black/50 hover:bg-white/5 relative transition-all duration-300"
                >
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-8">
                        <span class="font-mono text-sm text-neutral-500 min-w-32">
                            {post.date}
                        </span>
                        <h3 class="text-xl md:text-2xl font-medium text-neutral-200 group-hover:text-primary-green transition-colors">
                            {post.title}
                        </h3>
                    </div>
                    <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-4 group-hover:translate-x-0">
                        <ArrowUpRight className="w-6 h-6 text-primary-green" />
                    </div>

                    {/* Hover line accent */}
                    <div class="absolute left-0 top-0 h-full w-1 bg-primary-green scale-y-0 group-hover:scale-y-100 transition-transform origin-top duration-300" />
                </a>
            ))
        }
    </div>
</section>
